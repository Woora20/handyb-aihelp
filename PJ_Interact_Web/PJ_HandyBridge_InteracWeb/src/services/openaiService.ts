// src/services/openaiService.ts
import OpenAI from 'openai';

export interface ChatMessage {
  id: string;
  role: 'user' | 'assistant';
  content: string;
  timestamp: Date;
}

interface KnowledgeItem {
  keywords: string[];
  answer: string;
}

// Knowledge Base สำหรับคำตอบที่กำหนดไว้
const knowledgeBase: KnowledgeItem[] = [
  {
    keywords: ["เว็บนี้", "เว็บไซต์", "handy bridge", "แพลตฟอร์ม", "ระบบ", "ฟีเจอร์", "มีอะไรบ้าง"],
    answer: "Handy Bridge เป็นแพลตฟอร์มที่เกิดจากความเชื่อว่าภาษามือเป็นภาษาที่สวยงามและสมบูรณ์แบบ ที่นี่จะช่วยให้คุณได้เรียนรู้ตัวอักษร คำศัพท์ในชีวิตประจำวัน และประโยคที่สำคัญ พร้อมด้วยแบบฝึกหัดที่หลากหลาย\n\nเราเชื่อว่าภาษามือไม่ใช่แค่เครื่องมือสื่อสาร แต่เป็นสะพานเชื่อมที่จะทำให้ชุมชนคนหูหนวกและคนฟังได้มีโอกาสเข้าใจกันมากขึ้น สร้างสังคมที่ทุกคนมีส่วนร่วมอย่างเท่าเทียม"
  },
  {
    keywords: ["ใช้ยังไง", "วิธีใช้", "เริ่มต้น", "การใช้งาน", "เริ่มต้นยังไง"],
    answer: "การเริ่มต้นเรียนภาษามือเป็นการเปิดประตูสู่โลกใหม่ที่งดงาม ขั้นแรกสมัครสมาชิกแล้วเข้าสู่เมนูเรียนรู้ เริ่มจากตัวอักษรก่อน เพราะนั่นคือรากฐานสำคัญ\n\nเรียนไปตามจังหวะของตัวเอง ไม่ต้องรีบร้อน เมื่อรู้สึกมั่นใจแล้วค่อยไปลองทำแบบฝึกหัด ทุกคำถามและข้อสงสัยของคุณมีค่า อย่าลังเลที่จะมาคุยกับฉันเมื่อไหร่ก็ได้"
  },
  {
    keywords: ["ฟรี", "เสียเงิน", "ค่าใช้จ่าย", "ราคา", "เสียตังค์"],
    answer: "การเรียนรู้ภาษามือควรเป็นสิทธิของทุกคน ไม่ใช่สิทธิพิเศษของใครบางคน เราจึงเปิดให้ใช้งานฟรีทุกฟีเจอร์ เพราะเชื่อว่าการสื่อสารที่ดีไม่ควรมีราคา\n\nนี่เป็นโครงการที่เกิดจากหัวใจที่อยากเห็นสังคมไทยที่ทุกคนได้รับการยอมรับ ไม่ว่าจะสื่อสารด้วยเสียงหรือด้วยมือ ทุกคนล้วนมีคุณค่าเท่าเทียมกัน"
  },
  {
    keywords: ["ทำไม", "วัตถุประสงค์", "เป้าหมาย", "จุดมุ่งหมาย", "สร้างทำไม"],
    answer: "ชุมชนคนหูหนวกมีวัฒนธรรมและภาษาที่เป็นเอกลักษณ์และสวยงาม Handy Bridge เกิดขึ้นเพื่อให้คนฟังได้เห็นความงดงามของภาษามือ และเพื่อให้ชุมชนคนหูหนวกได้รับการเข้าใจมากขึ้น เป้าหมายของเราคือสังคมที่ทุกคนสามารถแสดงออกและสื่อสารได้อย่างเต็มที่"
  },
  {
    keywords: ["เรียนนานไหม", "ยาก", "ง่าย", "เวลา", "นานแค่ไหน"],
    answer: "ภาษามือเป็นภาษาที่สมบูรณ์และมีระบบไวยากรณ์ของตัวเอง เหมือนกับภาษาพูดทุกภาษา การเรียนรู้จึงต้องใช้เวลาและความอดทน แต่ทุกขั้นตอนล้วนมีความหมาย\n\nในช่วง 1-2 เดือนแรกคุณจะเริ่มคุ้นเคยกับตัวอักษรและคำพื้นฐาน ส่วนการสื่อสารที่ลื่นไหลนั้นขึ้นอยู่กับการฝึกฝนอย่างสม่ำเสมอ จุดสำคัญคือการเรียนรู้ด้วยความเคารพและความเข้าใจต่อวัฒนธรรมคนหูหนวก"
  },
  {
    keywords: ["คนหูหนวก", "สื่อสาร", "พูดคุย", "คุยกับคนหูหนวก", "หูหนวก", "พิการทางการได้ยิน"],
    answer: "ชุมชนคนหูหนวกมีวิธีการสื่อสารที่หลากหลายและสร้างสรรค์ นอกจากภาษามือแล้ว ยังมีการอ่านปาก การเขียน การใช้เทคโนโลยี และการสื่อสารด้วยสีหน้าท่าทางที่ลึกซึ้ง\n\nสิ่งสำคัญที่สุดคือการมองเขาในฐานะเพื่อนมนุษย์ที่มีความสามารถและศักยภาพเต็มตัว ไม่ใช่คนที่ต้องการความสงสาร ภาษามือที่คุณเรียนจะเป็นการแสดงความเคารพต่อวัฒนธรรมของเขา และเป็นก้าวแรกสู่มิตรภาพที่แท้จริง"
  },
  {
    keywords: ["วัฒนธรรม", "ชุมชน", "คนหูหนวก", "deaf culture", "ความแตกต่าง"],
    answer: "วัฒนธรรมคนหูหนวกเป็นสมบัติที่ล้ำค่าของสังคม มีศิลปะ วรรณกรรม และประเพณีที่เป็นเอกลักษณ์ ภาษามือไม่ได้เป็นแค่เครื่องมือ แต่เป็นหัวใจของเอกลักษณ์ทางวัฒนธรรม\n\nการเรียนรู้ภาษามือจึงไม่ใช่แค่การเรียนท่าทาง แต่เป็นการเปิดใจรับความแตกต่างและความงดงามในแบบฉบับที่ไม่เหมือนใคร เมื่อคุณเข้าใจวัฒนธรรมนี้ คุณจะได้พบกับมุมมองใหม่ที่อาจเปลี่ยนชีวิตคุณไปตลอดกาล"
  }
];

function findKnowledgeAnswer(question: string): string | null {
  const lowercaseQuestion = question.toLowerCase();
  
  for (const item of knowledgeBase) {
    for (const keyword of item.keywords) {
      if (lowercaseQuestion.includes(keyword.toLowerCase())) {
        return item.answer;
      }
    }
  }
  
  return null;
}

const openai = new OpenAI({
  apiKey: import.meta.env.VITE_OPENAI_API_KEY,
  dangerouslyAllowBrowser: true
});

export class OpenAIService {
  async sendMessage(message: string, chatHistory: ChatMessage[] = []): Promise<string> {
    try {
      // ตรวจสอบ knowledge base ก่อน
      const knowledgeAnswer = findKnowledgeAnswer(message);
      if (knowledgeAnswer) {
        return knowledgeAnswer;
      }

      // ถ้าไม่มีใน knowledge base ให้ใช้ OpenAI
      const messages = [
        {
          role: 'system' as const,
          content: `คุณคือ "HandyBot" เพื่อนผู้ช่วยที่เข้าใจเรื่องภาษามือไทย

บุคลิกของคุณ:
- พูดจาเป็นกันเอง อบอุ่น และให้กำลังใจ
- ใช้คำง่ายๆ ที่เข้าใจได้ทุกวัย
- ชอบให้คำแนะนำและเล่าประสบการณ์
- มีความอดทนและเข้าใจผู้เรียน

ความรู้และหน้าที่:
- ช่วยเหลือเรื่องภาษามือไทยทุกระดับ
- แนะนำท่าทางและคำศัพท์
- ให้กำลังใจและสร้างแรงบันดาลใจ
- ตอบคำถามเกี่ยวกับ Handy Bridge

ข้อมูลเกี่ยวกับ Handy Bridge:
- เป็นเว็บไซต์เรียนรู้ภาษามือไทยฟรี
- มีบทเรียนตัวอักษร คำศัพท์ และประโยค
- มีระบบฝึกฝนและทดสอบ
- เป็นโครงการเพื่อสังคม เชื่อมคนหูหนวกกับคนทั่วไป

วิธีการตอบ:
- ใช้ภาษาไทยที่เป็นธรรมชาติ ไม่เป็นทางการจนเกินไป
- ตอบแบบเพื่อนคุยกัน อบอุ่นและเข้าใจง่าย
- ให้ข้อมูลที่เป็นประโยชน์แต่ไม่ยาวจนเบื่อ
- เขียนเป็นย่อหน้าสั้นๆ อ่านง่าย
- ตอบเป็น plain text ธรรมดา ไม่ใช้ markdown หรือสัญลักษณ์พิเศษ`
        },
        ...chatHistory.slice(-4).map(msg => ({
          role: msg.role,
          content: msg.content
        })),
        {
          role: 'user' as const,
          content: message
        }
      ];

      const response = await openai.chat.completions.create({
        model: 'gpt-4o-mini',
        messages: messages,
        max_tokens: 800,
        temperature: 0.8,
      });

      return response.choices[0]?.message?.content || 'ขออภัย ไม่สามารถตอบได้ในขณะนี้';
    } catch (error) {
      console.error('OpenAI API Error:', error);
      
      if (error instanceof Error) {
        if (error.message.includes('insufficient_quota') || error.message.includes('billing')) {
          return 'ขออภัยครับ ระบบ AI มีปัญหาเรื่องเครดิต กรุณาลองใหม่ภายหลัง หรือติดต่อผู้ดูแลระบบ';
        }
        if (error.message.includes('invalid_api_key')) {
          return 'ขออภัยครับ มีปัญหาเกี่ยวกับการตั้งค่าระบบ กรุณาแจ้งผู้ดูแลระบบ';
        }
        if (error.message.includes('rate_limit')) {
          return 'ขออภัยครับ ตอนนี้มีคนใช้งานเยอะ กรุณารอสักครู่แล้วลองใหม่นะ';
        }
      }
      
      return 'ขออภัยครับ ตอนนี้ฉันมีปัญหาทางเทคนิค กรุณาลองถามใหม่ภายหลัง';
    }
  }
}

export const openaiService = new OpenAIService();